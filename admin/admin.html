<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stilistre • Admin Panel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root {
      --primary: #6a5acd;
      --secondary: #9370db;
      --accent: #ff6b6b;
      --light: #f8f9fa;
      --dark: #343a40;
      --text: #4a4a4a;
      --bg: #fff9fb;
      --card: #ffffff;
      --muted: #9aa0a6;
      --border: #ececf2;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: 'Montserrat', sans-serif;
      display: grid;
      grid-template-columns: 260px 1fr;
      grid-template-rows: 64px 1fr;
      grid-template-areas:
        "sidebar topbar"
        "sidebar main";
    }

    /* Sidebar */
    .sidebar {
      grid-area: sidebar;
      background: #fff;
      border-right: 1px solid var(--border);
      position: sticky; top: 0; height: 100vh;
      display: flex; flex-direction: column;
    }
    .brand {
      display: flex; align-items: center; gap: 10px;
      padding: 18px 18px; border-bottom: 1px solid var(--border);
    }
    .brand .logo {
      width: 36px; height: 36px; border-radius: 10px;
      display: grid; place-items: center; color: #fff;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      font-weight: 700;
    }
    .brand h1 { margin: 0; font-size: 18px; color: var(--primary); font-family: 'Playfair Display', serif; }
    .brand h1 span { color: var(--accent); }

    .nav { padding: 10px; overflow-y: auto; }
    .nav button {
      width: 100%;
      text-align: left;
      background: transparent;
      border: 0;
      font: 600 14px 'Montserrat', sans-serif;
      color: var(--dark);
      padding: 12px 14px; border-radius: 12px;
      display: flex; align-items: center; gap: 10px;
      cursor: pointer; transition: .2s ease;
    }
    .nav button:hover { background: #f4f2ff; color: var(--primary); }
    .nav button.active { background: linear-gradient(90deg, rgba(106,90,205,.12), rgba(147,112,219,.12)); color: var(--primary); }
    .sidebar .footer { margin-top: auto; padding: 12px; font-size: 12px; color: var(--muted); }

    /* Topbar */
    .topbar {
      grid-area: topbar; background: #fff; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between; padding: 0 18px;
    }
    .topbar .page-title { font-weight: 700; color: var(--dark); }
    .topbar .actions { display: flex; align-items: center; gap: 10px; }
    .chip {
      font-size: 12px; padding: 6px 10px; border-radius: 999px; background: #f3f4f6; color: #475569;
    }
    .btn {
      border: 0; border-radius: 12px; padding: 10px 14px; font-weight: 700; cursor: pointer;
      transition: .2s ease; display: inline-flex; align-items: center; gap: 8px;
    }
    .btn.primary { background: var(--accent); color: #fff; }
    .btn.primary:hover { filter: brightness(.95); transform: translateY(-1px); }
    .btn.ghost { background: #f3f4f6; color: #111827; }

    /* Main */
    main { grid-area: main; padding: 20px; }

    .cards { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 14px; margin-bottom: 18px; }
    .card {
      background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px;
      display: grid; gap: 8px;
    }
    .card .label { color: var(--muted); font-size: 12px; font-weight: 600; }
    .card .value { font-size: 22px; font-weight: 800; color: var(--dark); }
    .card .trend { font-size: 12px; }
    .trend.up { color: var(--success); }
    .trend.down { color: var(--danger); }

    .panel { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; }
    .panel + .panel { margin-top: 18px; }

    .panel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .panel-title { font-weight: 800; color: var(--dark); }

    .grid-2 { display: grid; grid-template-columns: 340px 1fr; gap: 16px; }

    /* Forms */
    .form { display: grid; gap: 10px; }
    .form .row { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 10px; }
    .form label { font-size: 12px; font-weight: 700; color: var(--dark); }
    .form input[type="text"], .form input[type="number"], .form select, .form input[type="file"] {
      border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; font: 600 14px 'Montserrat', sans-serif;
      background: #fff; color: var(--dark);
    }
    .form small { color: var(--muted); font-size: 11px; }

    /* Tables */
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 14px; }
    th { font-size: 12px; text-transform: uppercase; letter-spacing: .04em; color: var(--muted); }
    tr:hover td { background: #faf7ff; }
    .table-actions { display: flex; align-items: center; gap: 8px; }
    .icon-btn { border: 0; background: #f3f4f6; border-radius: 10px; padding: 8px; cursor: pointer; }
    .icon-btn.edit { color: #2563eb; }
    .icon-btn.delete { color: var(--danger); }

    /* Image preview */
    .image-picker { display: grid; gap: 8px; }
    .preview {
      width: 100%; aspect-ratio: 1.4/1; border: 1px dashed var(--border); border-radius: 12px; display: grid; place-items: center;
      background: #fbfbff; overflow: hidden;
    }
    .preview img { width: 100%; height: 100%; object-fit: cover; }

    /* Tabs/Sections */
    .section { display: none; }
    .section.active { display: block; }

    /* Badges */
    .badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 999px; font-size: 12px; font-weight: 700; }
    .badge.brand { background: rgba(106,90,205,.12); color: var(--primary); }
    .badge.cat { background: rgba(255,107,107,.12); color: var(--accent); }

    /* Responsive */
    @media (max-width: 1100px) { .cards { grid-template-columns: repeat(2, minmax(0,1fr)); } .grid-2 { grid-template-columns: 1fr; } body { grid-template-columns: 72px 1fr; } .brand h1 { display: none; } }
    @media (max-width: 640px) { .cards { grid-template-columns: 1fr; } .nav button span.label { display: none; } }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">S</div>
      <h1>STİL<span>İSTRE</span> • Admin</h1>
    </div>
    <nav class="nav">
      <button class="active" data-section="dashboard"><i class="fa-solid fa-chart-line"></i><span class="label">Dashboard</span></button>
      <button data-section="brands"><i class="fa-solid fa-tags"></i><span class="label">Markalar</span></button>
      <button data-section="categories"><i class="fa-solid fa-layer-group"></i><span class="label">Kategoriler</span></button>
      <button data-section="products"><i class="fa-solid fa-shirt"></i><span class="label">Ürünler</span></button>
    </nav>
    <div class="footer">Veriler demo amaçlı localStorage'da tutulur.</div>
  </aside>

  <!-- Topbar -->
  <header class="topbar">
    <div class="page-title">Dashboard</div>
    <div class="actions">
      <span class="chip" id="clock">--:--</span>
      <button class="btn ghost" id="clearData"><i class="fa-regular fa-trash-can"></i> Demo Verileri Temizle</button>
    </div>
  </header>

  <!-- Main -->
  <main>
    <!-- Dashboard -->
    <section id="dashboard" class="section active">
      <div class="cards">
        <div class="card"><div class="label">Toplam Ürün</div><div class="value" id="metricProducts">0</div><div class="trend up" id="metricProductsTrend">+0 bugün</div></div>
        <div class="card"><div class="label">Marka</div><div class="value" id="metricBrands">0</div><div class="trend" style="color:var(--primary)">aktif</div></div>
        <div class="card"><div class="label">Kategori</div><div class="value" id="metricCategories">0</div><div class="trend" style="color:var(--accent)">aktif</div></div>
        <div class="card"><div class="label">Stok Değeri (₺)</div><div class="value" id="metricValue">0</div><div class="trend down" id="metricDiscount">0 indirim</div></div>
      </div>
      <div class="panel">
        <div class="panel-header"><div class="panel-title">Son Eklenen Ürünler</div></div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Ürün</th>
                <th>Marka</th>
                <th>Kategori</th>
                <th>Stil</th>
                <th>Fiyat</th>
                <th>İnd. Fiyat</th>
                <th>Tarih</th>
              </tr>
            </thead>
            <tbody id="latestProducts"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Brands -->
    <section id="brands" class="section">
      <div class="grid-2">
        <div class="panel">
          <div class="panel-header"><div class="panel-title">Marka Ekle</div></div>
          <form id="brandForm" class="form">
            <div class="row">
              <div>
                <label>Marka Adı</label>
                <input type="text" id="brandName" placeholder="Örn: Nike" required />
              </div>
            </div>
            <button class="btn primary" type="submit"><i class="fa-solid fa-plus"></i> Ekle</button>
          </form>
          <small>Eklenen markalar ürün formundaki listede görünür.</small>
        </div>
        <div class="panel">
          <div class="panel-header"><div class="panel-title">Marka Listesi</div></div>
          <table>
            <thead><tr><th>#</th><th>Ad</th><th>İşlem</th></tr></thead>
            <tbody id="brandTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Categories -->
    <section id="categories" class="section">
      <div class="grid-2">
        <div class="panel">
          <div class="panel-header"><div class="panel-title">Kategori Ekle</div></div>
          <form id="categoryForm" class="form">
            <div class="row">
              <div>
                <label>Kategori Adı</label>
                <input type="text" id="categoryName" placeholder="Örn: Tişört, Şort" required />
              </div>
            </div>
            <button class="btn primary" type="submit"><i class="fa-solid fa-plus"></i> Ekle</button>
          </form>
          <small>Ürün stilini kategori olarak düşünebilirsin (Tişört/Şort vb.).</small>
        </div>
        <div class="panel">
          <div class="panel-header"><div class="panel-title">Kategori Listesi</div></div>
          <table>
            <thead><tr><th>#</th><th>Ad</th><th>İşlem</th></tr></thead>
            <tbody id="categoryTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Products -->
    <section id="products" class="section">
      <div class="panel">
        <div class="panel-header"><div class="panel-title">Ürün Ekle / Düzenle</div><button id="resetProductForm" class="btn ghost"><i class="fa-solid fa-rotate-left"></i> Formu Sıfırla</button></div>
        <form id="productForm" class="form">
          <input type="hidden" id="productId" />
          <div class="row">
            <div>
              <label>Ürün Adı</label>
              <input type="text" id="productName" placeholder="Örn: Yazlık Desenli Elbise" required />
            </div>
            <div>
              <label>Marka</label>
              <select id="productBrand" required></select>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Kategori / Stil</label>
              <select id="productCategory" required></select>
            </div>
            <div>
              <label>Stil (Opsiyonel Metin)</label>
              <input type="text" id="productStyle" placeholder="Örn: Oversize, Basic" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Fiyat (₺)</label>
              <input type="number" id="productPrice" min="0" step="0.01" required />
            </div>
            <div>
              <label>İndirimli Fiyat (₺)</label>
              <input type="number" id="productSalePrice" min="0" step="0.01" placeholder="İndirim yoksa boş bırak" />
            </div>
          </div>
          <div class="row">
            <div class="image-picker">
              <label>Ürün Görseli</label>
              <div class="preview" id="imagePreview"><span><i class="fa-regular fa-image"></i> Önizleme</span></div>
              <input type="file" id="productImage" accept="image/*" />
              <small>Görsel demo için localStorage'da Base64 olarak tutulur.</small>
            </div>
            <div style="display:grid;align-content:end;gap:10px;">
              <button class="btn primary" type="submit"><i class="fa-solid fa-floppy-disk"></i> Kaydet</button>
              <button type="button" class="btn ghost" id="fillSample"><i class="fa-regular fa-lightbulb"></i> Örnek Doldur</button>
            </div>
          </div>
        </form>
      </div>

      <div class="panel">
        <div class="panel-header"><div class="panel-title">Ürün Listesi</div>
          <div style="display:flex; gap:8px;">
            <input id="search" type="text" placeholder="Ara..." style="padding:10px 12px;border:1px solid var(--border);border-radius:10px;">
            <select id="filterBrand" style="padding:10px 12px;border:1px solid var(--border);border-radius:10px;"></select>
            <select id="filterCategory" style="padding:10px 12px;border:1px solid var(--border);border-radius:10px;"></select>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Ürün</th>
                <th>Marka</th>
                <th>Kategori</th>
                <th>Stil</th>
                <th>Fiyat</th>
                <th>İnd. Fiyat</th>
                <th>Görsel</th>
                <th>İşlemler</th>
              </tr>
            </thead>
            <tbody id="productTable"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ===== Utilities & Storage =====
    const uid = () => Math.random().toString(36).slice(2, 9);
    const LS = {
      get: (k, d) => JSON.parse(localStorage.getItem(k) || JSON.stringify(d)),
      set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
      del: (k) => localStorage.removeItem(k)
    };

    const state = {
      brands: [],
      categories: [],
      products: [],
      todayAdded: 0,
    };

    function loadState() {
      state.brands = LS.get('brands', [
        { id: uid(), name: 'Nike' },
        { id: uid(), name: 'Adidas' },
      ]);
      state.categories = LS.get('categories', [
        { id: uid(), name: 'Tişört' },
        { id: uid(), name: 'Şort' },
      ]);
      state.products = LS.get('products', []);
    }

    function saveState() {
      LS.set('brands', state.brands);
      LS.set('categories', state.categories);
      LS.set('products', state.products);
    }

    // ===== Nav Handling =====
    const pageTitle = document.querySelector('.page-title');
    document.querySelectorAll('.nav button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const id = btn.dataset.section;
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        pageTitle.textContent = btn.textContent.trim();
      })
    });

    // ===== Clock =====
    function tick() {
      const d = new Date();
      const pad = n => String(n).padStart(2,'0');
      document.getElementById('clock').textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    setInterval(tick, 1000); tick();

    // ===== Brand CRUD =====
    const brandForm = document.getElementById('brandForm');
    const brandName = document.getElementById('brandName');
    const brandTable = document.getElementById('brandTable');

    function renderBrands() {
      // fill table
      brandTable.innerHTML = '';
      state.brands.forEach((b, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${b.name}</td><td class="table-actions">
          <button class="icon-btn delete" title="Sil" data-id="${b.id}"><i class='fa-solid fa-trash'></i></button>
        </td>`;
        brandTable.appendChild(tr);
      });

      // fill filters + product selects
      const productBrand = document.getElementById('productBrand');
      const filterBrand = document.getElementById('filterBrand');
      productBrand.innerHTML = '<option value="" disabled selected>Seçiniz</option>' + state.brands.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
      filterBrand.innerHTML = '<option value="">Tüm Markalar</option>' + state.brands.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
    }

    brandForm.addEventListener('submit', e => {
      e.preventDefault();
      const name = brandName.value.trim();
      if(!name) return;
      state.brands.push({ id: uid(), name });
      brandName.value = '';
      saveState();
      renderBrands();
      renderMetrics();
    });

    brandTable.addEventListener('click', e => {
      const btn = e.target.closest('button');
      if(!btn) return;
      const id = btn.dataset.id;
      // Prevent delete if in use? (we allow delete; products keep orphaned brand id -> we handle name lookup fallbacks)
      state.brands = state.brands.filter(b=>b.id!==id);
      saveState();
      renderBrands();
      renderProducts();
      renderMetrics();
    });

    // ===== Category CRUD =====
    const categoryForm = document.getElementById('categoryForm');
    const categoryName = document.getElementById('categoryName');
    const categoryTable = document.getElementById('categoryTable');

    function renderCategories() {
      categoryTable.innerHTML = '';
      state.categories.forEach((c,i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${c.name}</td><td class="table-actions">
          <button class="icon-btn delete" title="Sil" data-id="${c.id}"><i class='fa-solid fa-trash'></i></button>
        </td>`;
        categoryTable.appendChild(tr);
      });

      const productCategory = document.getElementById('productCategory');
      const filterCategory = document.getElementById('filterCategory');
      productCategory.innerHTML = '<option value="" disabled selected>Seçiniz</option>' + state.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
      filterCategory.innerHTML = '<option value="">Tüm Kategoriler</option>' + state.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    }

    categoryForm.addEventListener('submit', e => {
      e.preventDefault();
      const name = categoryName.value.trim();
      if(!name) return;
      state.categories.push({ id: uid(), name });
      categoryName.value = '';
      saveState();
      renderCategories();
      renderMetrics();
    });

    categoryTable.addEventListener('click', e => {
      const btn = e.target.closest('button');
      if(!btn) return;
      const id = btn.dataset.id;
      state.categories = state.categories.filter(c=>c.id!==id);
      saveState();
      renderCategories();
      renderProducts();
      renderMetrics();
    });

    // ===== Product CRUD =====
    const productForm = document.getElementById('productForm');
    const productId = document.getElementById('productId');
    const productName = document.getElementById('productName');
    const productBrand = document.getElementById('productBrand');
    const productCategory = document.getElementById('productCategory');
    const productStyle = document.getElementById('productStyle');
    const productPrice = document.getElementById('productPrice');
    const productSalePrice = document.getElementById('productSalePrice');
    const productImage = document.getElementById('productImage');
    const imagePreview = document.getElementById('imagePreview');
    const productTable = document.getElementById('productTable');

    let imageData = '';

    productImage.addEventListener('change', () => {
      const file = productImage.files?.[0];
      if(!file) { imageData=''; imagePreview.innerHTML = '<span><i class="fa-regular fa-image"></i> Önizleme</span>'; return; }
      const reader = new FileReader();
      reader.onload = () => { imageData = reader.result; imagePreview.innerHTML = `<img src="${imageData}" alt="preview">`; };
      reader.readAsDataURL(file);
    });

    function resetProductForm() {
      productId.value = '';
      productName.value = '';
      productBrand.value = '';
      productCategory.value = '';
      productStyle.value = '';
      productPrice.value = '';
      productSalePrice.value = '';
      productImage.value = '';
      imageData = '';
      imagePreview.innerHTML = '<span><i class="fa-regular fa-image"></i> Önizleme</span>';
      document.querySelector('#resetProductForm').disabled = false;
    }

    document.getElementById('resetProductForm').addEventListener('click', resetProductForm);

    document.getElementById('fillSample').addEventListener('click', () => {
      productName.value = 'Kadın Spor Ayakkabı';
      try { productBrand.selectedIndex = 1; } catch {}
      try { productCategory.selectedIndex = 1; } catch {}
      productStyle.value = 'Koşu';
      productPrice.value = '699.99';
      productSalePrice.value = '499.99';
    });

    productForm.addEventListener('submit', e => {
      e.preventDefault();
      const name = productName.value.trim();
      const brandId = productBrand.value;
      const categoryId = productCategory.value;
      const style = productStyle.value.trim();
      const price = parseFloat(productPrice.value || '0');
      const salePrice = productSalePrice.value ? parseFloat(productSalePrice.value) : null;
      if (!name || !brandId || !categoryId || isNaN(price)) return;
      if (salePrice !== null && salePrice > price) {
        alert('İndirimli fiyat normal fiyattan büyük olamaz.');
        return;
      }

      const now = new Date().toISOString();

      if (productId.value) {
        // update
        const id = productId.value;
        const p = state.products.find(p=>p.id===id);
        if (p) {
          p.name = name; p.brandId = brandId; p.categoryId = categoryId; p.style = style; p.price = price; p.salePrice = salePrice;
          if (imageData) p.image = imageData; // keep previous if new image not selected
        }
      } else {
        state.products.unshift({ id: uid(), name, brandId, categoryId, style, price, salePrice, image: imageData, createdAt: now });
        state.todayAdded++;
      }

      saveState();
      renderProducts();
      renderMetrics();
      renderLatest();
      resetProductForm();
    });

    function brandNameById(id){ return state.brands.find(b=>b.id===id)?.name || '—'; }
    function categoryNameById(id){ return state.categories.find(c=>c.id===id)?.name || '—'; }

    function money(n){ if(typeof n!== 'number' || isNaN(n)) return '—'; return new Intl.NumberFormat('tr-TR', {style:'currency', currency:'TRY', maximumFractionDigits:2}).format(n); }

    const search = document.getElementById('search');
    const filterBrand = document.getElementById('filterBrand');
    const filterCategory = document.getElementById('filterCategory');

    function renderProducts() {
      const q = search.value.toLowerCase();
      const fb = filterBrand.value; const fc = filterCategory.value;
      productTable.innerHTML = '';
      state.products
        .filter(p => (!q || p.name.toLowerCase().includes(q)) && (!fb || p.brandId===fb) && (!fc || p.categoryId===fc))
        .forEach((p,i) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${i+1}</td>
            <td><strong>${p.name}</strong></td>
            <td><span class='badge brand'><i class="fa-solid fa-tag"></i> ${brandNameById(p.brandId)}</span></td>
            <td><span class='badge cat'><i class="fa-solid fa-layer-group"></i> ${categoryNameById(p.categoryId)}</span></td>
            <td>${p.style || '—'}</td>
            <td>${money(p.price)}</td>
            <td>${p.salePrice!==null && p.salePrice!==undefined ? money(p.salePrice) : '—'}</td>
            <td>${p.image ? `<img src='${p.image}' alt='img' style='width:44px;height:44px;object-fit:cover;border-radius:8px;border:1px solid var(--border);'/>` : '—'}</td>
            <td class='table-actions'>
              <button class='icon-btn edit' title='Düzenle' data-id='${p.id}'><i class="fa-regular fa-pen-to-square"></i></button>
              <button class='icon-btn delete' title='Sil' data-id='${p.id}'><i class="fa-solid fa-trash"></i></button>
            </td>`;
          productTable.appendChild(tr);
        });
    }

    productTable.addEventListener('click', e => {
      const btn = e.target.closest('button'); if(!btn) return;
      const id = btn.dataset.id; const p = state.products.find(p=>p.id===id);
      if(btn.classList.contains('delete')) {
        if(confirm('Ürünü silmek istediğine emin misin?')){
          state.products = state.products.filter(x=>x.id!==id);
          saveState(); renderProducts(); renderMetrics(); renderLatest();
        }
        return;
      }
      if(btn.classList.contains('edit') && p){
        productId.value = p.id;
        productName.value = p.name;
        productBrand.value = p.brandId;
        productCategory.value = p.categoryId;
        productStyle.value = p.style || '';
        productPrice.value = p.price;
        productSalePrice.value = (p.salePrice ?? '');
        imageData = '';
        imagePreview.innerHTML = p.image ? `<img src='${p.image}' alt='img'>` : '<span><i class="fa-regular fa-image"></i> Önizleme</span>';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    });

    search.addEventListener('input', renderProducts);
    filterBrand.addEventListener('change', renderProducts);
    filterCategory.addEventListener('change', renderProducts);

    // ===== Dashboard Metrics & Latest =====
    function renderMetrics(){
      document.getElementById('metricProducts').textContent = state.products.length;
      document.getElementById('metricBrands').textContent = state.brands.length;
      document.getElementById('metricCategories').textContent = state.categories.length;
      const totalValue = state.products.reduce((sum,p)=> sum + (p.salePrice ?? p.price ?? 0), 0);
      const totalFull = state.products.reduce((sum,p)=> sum + (p.price ?? 0), 0);
      const discountSaved = Math.max(totalFull - totalValue, 0);
      document.getElementById('metricValue').textContent = new Intl.NumberFormat('tr-TR').format(totalValue.toFixed ? Number(totalValue.toFixed(2)) : totalValue);
      document.getElementById('metricDiscount').textContent = `${money(discountSaved)} indirim`;
      document.getElementById('metricProductsTrend').textContent = `+${state.todayAdded} bugün`;
    }

    function renderLatest(){
      const tbody = document.getElementById('latestProducts');
      tbody.innerHTML = '';
      state.products.slice(0,5).forEach(p=>{
        const tr = document.createElement('tr');
        const date = p.createdAt ? new Date(p.createdAt) : null;
        tr.innerHTML = `
          <td>${p.name}</td>
          <td>${brandNameById(p.brandId)}</td>
          <td>${categoryNameById(p.categoryId)}</td>
          <td>${p.style || '—'}</td>
          <td>${money(p.price)}</td>
          <td>${p.salePrice!==null && p.salePrice!==undefined ? money(p.salePrice) : '—'}</td>
          <td>${date ? date.toLocaleDateString('tr-TR') : '—'}</td>`;
        tbody.appendChild(tr);
      });
    }

    // ===== Data Reset =====
    document.getElementById('clearData').addEventListener('click', () => {
      if(!confirm('Tüm demo verileri silinsin mi?')) return;
      ['brands','categories','products'].forEach(k=>LS.del(k));
      state.todayAdded = 0;
      loadState(); saveState();
      renderBrands(); renderCategories(); renderProducts(); renderMetrics(); renderLatest();
    });

    // ===== Init =====
    loadState(); saveState();
    renderBrands(); renderCategories(); renderProducts(); renderMetrics(); renderLatest();
  </script>
</body>
</html>
